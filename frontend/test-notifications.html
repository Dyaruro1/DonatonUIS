<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Notifications System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #18192b;
            color: white;
        }
        .test-section {
            background: #23233a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #21e058;
            color: #18192b;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #1bc048;
        }
        .log {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: #21e058; }
        .error { color: #ff6b6b; }
        .info { color: #74c0fc; }
    </style>
</head>
<body>
    <h1>üîî Test del Sistema de Notificaciones</h1>
    
    <div class="test-section">
        <h2>Estado del Sistema</h2>
        <div id="status">Verificando conexi√≥n con Supabase...</div>
    </div>

    <div class="test-section">
        <h2>Pruebas de Funcionalidad</h2>
        <button onclick="testSupabaseConnection()">1. Probar Conexi√≥n Supabase</button>
        <button onclick="testNotificationsTable()">2. Verificar Tabla Notifications</button>
        <button onclick="testCreateNotification()">3. Crear Notificaci√≥n de Prueba</button>
        <button onclick="testRealtimeSubscription()">4. Probar Suscripci√≥n en Tiempo Real</button>
        <button onclick="clearLogs()">Limpiar Logs</button>
    </div>

    <div class="test-section">
        <h2>Logs del Sistema</h2>
        <div id="logs" class="log">Esperando pruebas...</div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Configuraci√≥n de Supabase (usar las mismas credenciales que en el proyecto)
        const supabaseUrl = 'https://your-supabase-url.supabase.co';
        const supabaseKey = 'your-supabase-anon-key';
        const supabase = createClient(supabaseUrl, supabaseKey);

        let logsElement = document.getElementById('logs');
        let statusElement = document.getElementById('status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logsElement.innerHTML += `<span class="${type}">${logEntry}</span>`;
            logsElement.scrollTop = logsElement.scrollHeight;
        }

        function clearLogs() {
            logsElement.innerHTML = 'Logs limpiados...\n';
        }

        // Funci√≥n para probar la conexi√≥n con Supabase
        window.testSupabaseConnection = async function() {
            log('üîç Probando conexi√≥n con Supabase...', 'info');
            try {
                const { data, error } = await supabase.from('messages').select('count').limit(1);
                if (error) {
                    log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                    statusElement.innerHTML = '<span class="error">‚ùå Conexi√≥n fallida</span>';
                } else {
                    log('‚úÖ Conexi√≥n con Supabase exitosa', 'success');
                    statusElement.innerHTML = '<span class="success">‚úÖ Conectado a Supabase</span>';
                }
            } catch (err) {
                log(`‚ùå Error inesperado: ${err.message}`, 'error');
                statusElement.innerHTML = '<span class="error">‚ùå Error de conexi√≥n</span>';
            }
        };

        // Funci√≥n para verificar si existe la tabla notifications
        window.testNotificationsTable = async function() {
            log('üîç Verificando tabla notifications...', 'info');
            try {
                const { data, error } = await supabase
                    .from('notifications')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log(`‚ùå Error al acceder a la tabla notifications: ${error.message}`, 'error');
                    if (error.code === 'PGRST116') {
                        log('üí° La tabla notifications no existe. Ejecuta el script SQL de configuraci√≥n.', 'info');
                    }
                } else {
                    log('‚úÖ Tabla notifications accesible', 'success');
                }
            } catch (err) {
                log(`‚ùå Error inesperado: ${err.message}`, 'error');
            }
        };

        // Funci√≥n para crear una notificaci√≥n de prueba
        window.testCreateNotification = async function() {
            log('üîç Creando notificaci√≥n de prueba...', 'info');
            try {
                const testNotification = {
                    user_id: 1, // ID de prueba
                    sender_id: 2, // ID de prueba
                    prenda_id: 1, // ID de prueba
                    message: 'Mensaje de prueba del sistema de notificaciones',
                    read: false,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('notifications')
                    .insert(testNotification)
                    .select();

                if (error) {
                    log(`‚ùå Error al crear notificaci√≥n: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Notificaci√≥n creada exitosamente: ${JSON.stringify(data[0], null, 2)}`, 'success');
                }
            } catch (err) {
                log(`‚ùå Error inesperado: ${err.message}`, 'error');
            }
        };

        // Funci√≥n para probar la suscripci√≥n en tiempo real
        window.testRealtimeSubscription = async function() {
            log('üîç Probando suscripci√≥n en tiempo real...', 'info');
            try {
                const channel = supabase
                    .channel('realtime:notifications-test')
                    .on('postgres_changes', { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'notifications' 
                    }, (payload) => {
                        log(`üîî Nueva notificaci√≥n recibida en tiempo real: ${JSON.stringify(payload.new, null, 2)}`, 'success');
                    })
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            log('‚úÖ Suscripci√≥n en tiempo real activa', 'success');
                        } else {
                            log(`‚ö†Ô∏è Estado de suscripci√≥n: ${status}`, 'info');
                        }
                    });

                // Limpiar suscripci√≥n despu√©s de 30 segundos
                setTimeout(() => {
                    supabase.removeChannel(channel);
                    log('üîá Suscripci√≥n en tiempo real desactivada', 'info');
                }, 30000);

            } catch (err) {
                log(`‚ùå Error en suscripci√≥n: ${err.message}`, 'error');
            }
        };

        // Verificar conexi√≥n al cargar la p√°gina
        window.onload = function() {
            testSupabaseConnection();
        };
    </script>
</body>
</html>
